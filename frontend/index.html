<!DOCTYPE html>
<html>
<head>
    <title>RBAC System</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f0f0f0; 
        }
        .box { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, button, select { 
            padding: 10px; 
            margin: 5px; 
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        .green { background: #28a745; }
        .red { background: #dc3545; }
        .small-btn {
            padding: 4px 8px;
            font-size: 12px;
            margin: 2px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
        }
        th, td { 
            padding: 8px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        th { background: #f8f9fa; }
        .message { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 3px; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        .admin-controls {
            margin-bottom: 15px;
        }
        .role-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .admin-badge { background: #dc3545; color: white; }
        .manager-badge { background: #ffc107; color: #212529; }
        .user-badge { background: #28a745; color: white; }
        
        /* üÜï Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        .pagination button {
            padding: 8px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination button:hover { background: #5a6268; }
        .pagination button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .pagination .current {
            background: #007bff;
            font-weight: bold;
        }
        .info-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="box">
        <h1>üéØ RBAC System Assessment</h1>
        <p><strong>Backend:</strong> http://localhost:8000 | <strong>Frontend:</strong> Simple HTML</p>
    </div>

    <!-- Message -->
    <div id="message" class="message hidden"></div>

    <!-- Login Section -->
    <div id="login-section" class="box">
        <h2>üîê Login</h2>
        <input type="text" id="username" placeholder="Username" style="width: 200px;">
        <input type="password" id="password" placeholder="Password" style="width: 200px;">
        <br>
        <button onclick="login()">Login</button>
        <button onclick="createAdmin()" class="green">Create Admin</button>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="hidden">
        <div class="box">
            <h2>Welcome <span id="user-name"></span>!</h2>
            <p>Role: <strong id="user-role"></strong></p>
            <button onclick="logout()" class="red">Logout</button>
        </div>

        <!-- Buttons for ALL users -->
        <div class="box">
            <h3>üéÆ Interactive Buttons</h3>
            <button onclick="clickButton('Button A')" class="green">Button A</button>
            <button onclick="clickButton('Button B')" class="red">Button B</button>
            <div id="click-result" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="box hidden">
            <h3>üë®‚Äçüíº Admin Panel</h3>
            
            <h4>Create User:</h4>
            <input type="text" id="new-username" placeholder="Username">
            <input type="password" id="new-password" placeholder="Password">
            <select id="new-role">
                <option value="user">User</option>
                <option value="manager">Manager</option>
                <option value="admin">Admin</option>
            </select>
            <button onclick="createUser()">Create User</button>

            <h4>All Users:</h4>
            <!-- üÜï Users Info -->
            <div id="users-info" class="info-text"></div>
            
            <table id="users-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Created</th>
                        <th>Actions</th> <!-- üÜï Delete Actions -->
                    </tr>
                </thead>
                <tbody id="users-tbody"></tbody>
            </table>
            
            <!-- üÜï Users Pagination -->
            <div id="users-pagination" class="pagination"></div>
        </div>

        <!-- Activity Logs -->
        <div id="logs-panel" class="box hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>üìä Activity Logs</h3>
                <!-- Admin-only controls -->
                <div id="admin-log-controls" class="admin-controls hidden">
                    <button onclick="clearAllLogs()" class="red small-btn">üóëÔ∏è Clear All</button>
                    <button onclick="loadLogs()" class="green small-btn">üîÑ Refresh</button>
                </div>
            </div>
            
            <!-- Role permission info -->
            <div id="role-permission-info" style="margin-bottom: 15px;"></div>
            
            <!-- üÜï Logs Info -->
            <div id="logs-info" class="info-text"></div>
            
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Button</th>
                        <th>Time</th>
                        <th id="admin-actions-header" class="hidden">Admin Actions</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody"></tbody>
            </table>
            
            <!-- üÜï Logs Pagination -->
            <div id="logs-pagination" class="pagination"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let token = null;
        
        // üÜï Pagination state
        let currentUsersPage = 1;
        let currentLogsPage = 1;
        let totalUsersPages = 1;
        let totalLogsPages = 1;

        // Show message
        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }

        // API call
        async function apiCall(url, method = 'GET', data = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers.Authorization = `Bearer ${token}`;

            const response = await fetch(`https://backend-assignment-vk4s.onrender.com/api${url}`, {
                method,
                headers,
                body: data ? JSON.stringify(data) : null
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API Error');
            }

            return response.json();
        }

        // Create Admin
        async function createAdmin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showMessage('Enter username and password', 'error');
                return;
            }

            try {
                await apiCall('/admin/create-admin', 'POST', { username, password });
                showMessage('‚úÖ Admin created! Now login.');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                showMessage(`‚ùå ${error.message}`, 'error');
            }
        }

        // Login
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showMessage('Enter username and password', 'error');
                return;
            }

            try {
                const response = await apiCall('/auth/login', 'POST', { username, password });
                
                currentUser = response.user;
                token = response.token;

                // Show dashboard
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Update user info
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-role').textContent = currentUser.role.toUpperCase();

                // Show panels based on role
                if (currentUser.role === 'admin') {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    document.getElementById('logs-panel').classList.remove('hidden');
                    document.getElementById('admin-log-controls').classList.remove('hidden');
                    document.getElementById('admin-actions-header').classList.remove('hidden');
                    loadUsers();
                    loadLogs();
                } else if (currentUser.role === 'manager') {
                    document.getElementById('logs-panel').classList.remove('hidden');
                    loadLogs();
                }

                updateRolePermissionInfo();
                showMessage(`üéâ Welcome ${currentUser.role.toUpperCase()}!`);
            } catch (error) {
                showMessage(`‚ùå ${error.message}`, 'error');
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            token = null;
            currentUsersPage = 1;
            currentLogsPage = 1;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('logs-panel').classList.add('hidden');
            document.getElementById('admin-log-controls').classList.add('hidden');
            document.getElementById('admin-actions-header').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showMessage('üëã Logged out');
        }

        // Update role permission info
        function updateRolePermissionInfo() {
            const infoDiv = document.getElementById('role-permission-info');
            
            if (currentUser.role === 'admin') {
                infoDiv.innerHTML = `
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; border-left: 4px solid #007bff;">
                        <strong>üî¥ ADMIN PRIVILEGES:</strong> You have full control - View, Update, Delete logs & users
                    </div>
                `;
            } else if (currentUser.role === 'manager') {
                infoDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <strong>üü° MANAGER ACCESS:</strong> Read-only access - You can view logs but cannot modify them
                    </div>
                `;
            }
        }

        // Click Button
        async function clickButton(buttonName) {
            try {
                await apiCall('/activity/log-click', 'POST', { buttonClicked: buttonName });
                document.getElementById('click-result').textContent = `‚úÖ ${buttonName} clicked!`;
                
                // Refresh logs if user can see them
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    loadLogs();
                }
                
                setTimeout(() => {
                    document.getElementById('click-result').textContent = '';
                }, 2000);
            } catch (error) {
                document.getElementById('click-result').textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Create User (Admin only)
        async function createUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            if (!username || !password) {
                showMessage('Enter username and password', 'error');
                return;
            }

            try {
                await apiCall('/admin/create-user', 'POST', { username, password, role });
                showMessage(`‚úÖ ${role.toUpperCase()} created!`);
                
                // Clear form
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('new-role').value = 'user';
                
                loadUsers();
            } catch (error) {
                showMessage(`‚ùå ${error.message}`, 'error');
            }
        }

        // üÜï Load Users with Pagination
        async function loadUsers(page = 1) {
            try {
                const response = await apiCall(`/admin/users?page=${page}&limit=5`);
                const tbody = document.getElementById('users-tbody');
                
                currentUsersPage = response.page;
                totalUsersPages = response.totalPages;
                
                // Update info
                document.getElementById('users-info').textContent = 
                    `Showing ${response.docs.length} of ${response.totalDocs} users (Page ${response.page}/${response.totalPages})`;
                
                tbody.innerHTML = response.docs.map(user => `
                    <tr>
                        <td>${user.username}</td>
                        <td><span class="${user.role}-badge role-badge">${user.role.toUpperCase()}</span></td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button onclick="deleteUser('${user._id}', '${user.username}')" class="small-btn red">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `).join('');
                
                // Update pagination
                updateUsersPagination();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // üÜï Load Logs with Pagination
        async function loadLogs(page = 1) {
            try {
                const response = await apiCall(`/activity/logs?page=${page}&limit=2`);
                const tbody = document.getElementById('logs-tbody');
                
                currentLogsPage = response.page;
                totalLogsPages = response.totalPages;
                
                // Update info
                document.getElementById('logs-info').textContent = 
                    `Showing ${response.docs.length} of ${response.totalDocs} logs (Page ${response.page}/${response.totalPages})`;
                
                if (response.docs && response.docs.length > 0) {
                    if (currentUser.role === 'admin') {
                        // Admin sees logs with action buttons
                        tbody.innerHTML = response.docs.map(log => `
                            <tr>
                                <td>${log.username}</td>
                                <td><span class="${log.role}-badge role-badge">${log.role.toUpperCase()}</span></td>
                                <td>${log.buttonClicked}</td>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                                <td>
                                    <button onclick="updateLog('${log._id}', '${log.buttonClicked}')" class="small-btn">‚úèÔ∏è Edit</button>
                                    <button onclick="deleteLog('${log._id}')" class="small-btn red">üóëÔ∏è Del</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        // Manager sees read-only logs
                        tbody.innerHTML = response.docs.map(log => `
                            <tr>
                                <td>${log.username}</td>
                                <td><span class="${log.role}-badge role-badge">${log.role.toUpperCase()}</span></td>
                                <td>${log.buttonClicked}</td>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                            </tr>
                        `).join('');
                    }
                } else {
                    const colspan = currentUser.role === 'admin' ? '5' : '4';
                    tbody.innerHTML = `<tr><td colspan="${colspan}">No logs yet. Click some buttons!</td></tr>`;
                }
                
                // Update pagination
                updateLogsPagination();
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        // üÜï Update Users Pagination
        function updateUsersPagination() {
            const pagination = document.getElementById('users-pagination');
            
            if (totalUsersPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button onclick="loadUsers(${currentUsersPage - 1})" ${currentUsersPage === 1 ? 'disabled' : ''}>‚ùÆ Prev</button>`;
            
            // Page numbers
            for (let i = 1; i <= totalUsersPages; i++) {
                const current = i === currentUsersPage ? 'current' : '';
                paginationHTML += `<button class="${current}" onclick="loadUsers(${i})">${i}</button>`;
            }
            
            // Next button
            paginationHTML += `<button onclick="loadUsers(${currentUsersPage + 1})" ${currentUsersPage === totalUsersPages ? 'disabled' : ''}>Next ‚ùØ</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        // üÜï Update Logs Pagination
        function updateLogsPagination() {
            const pagination = document.getElementById('logs-pagination');
            
            if (totalLogsPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button onclick="loadLogs(${currentLogsPage - 1})" ${currentLogsPage === 1 ? 'disabled' : ''}>‚ùÆ Prev</button>`;
            
            // Page numbers
            for (let i = 1; i <= totalLogsPages; i++) {
                const current = i === currentLogsPage ? 'current' : '';
                paginationHTML += `<button class="${current}" onclick="loadLogs(${i})">${i}</button>`;
            }
            
            // Next button
            paginationHTML += `<button onclick="loadLogs(${currentLogsPage + 1})" ${currentLogsPage === totalLogsPages ? 'disabled' : ''}>Next ‚ùØ</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        // üÜï Delete User (Admin only)
        async function deleteUser(userId, username) {
            if (currentUser.role !== 'admin') {
                showMessage('‚ùå Only admins can delete users', 'error');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete user "${username}"?\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await apiCall(`/admin/delete-user/${userId}`, 'DELETE');
                showMessage(`‚úÖ User "${username}" deleted successfully`);
                loadUsers(currentUsersPage); // Refresh current page
            } catch (error) {
                showMessage(`‚ùå Error deleting user: ${error.message}`, 'error');
            }
        }

        // Admin-only: Update Log
        async function updateLog(logId, currentButton) {
            if (currentUser.role !== 'admin') {
                showMessage('‚ùå Only admins can update logs', 'error');
                return;
            }
            
            const newButton = prompt(`Update button click (current: ${currentButton})\nEnter "Button A" or "Button B":`, currentButton);
            
            if (!newButton || (newButton !== 'Button A' && newButton !== 'Button B')) {
                if (newButton !== null) {
                    showMessage('‚ùå Invalid button. Use "Button A" or "Button B"', 'error');
                }
                return;
            }
            
            try {
                const response = await apiCall(`/activity/update/${logId}`, 'PUT', {
                    buttonClicked: newButton
                });
                showMessage(`‚úÖ ${response.message}`);
                loadLogs(currentLogsPage);
            } catch (error) {
                showMessage(`‚ùå Error updating log: ${error.message}`, 'error');
            }
        }

        // Admin-only: Delete Log
        async function deleteLog(logId) {
            if (currentUser.role !== 'admin') {
                showMessage('‚ùå Only admins can delete logs', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this log entry?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/activity/delete/${logId}`, 'DELETE');
                showMessage(`‚úÖ ${response.message}`);
                loadLogs(currentLogsPage);
            } catch (error) {
                showMessage(`‚ùå Error deleting log: ${error.message}`, 'error');
            }
        }

        // Admin-only: Clear All Logs
        async function clearAllLogs() {
            if (currentUser.role !== 'admin') {
                showMessage('‚ùå Only admins can clear all logs', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Are you sure you want to DELETE ALL LOGS?\nThis action cannot be undone!')) {
                return;
            }
            
            try {
                await apiCall('/activity/logs/clear', 'DELETE');
                showMessage('‚úÖ All logs cleared successfully');
                loadLogs(1);
            } catch (error) {
                showMessage(`‚ùå Error clearing logs: ${error.message}`, 'error');
            }
        }

        console.log('üöÄ RBAC Frontend ready with pagination!');
        console.log('üì° Make sure backend is running on http://localhost:8000');
    </script>
</body>
</html>
